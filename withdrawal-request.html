<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Withdrawal Requests - EverNet</title>
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#001f3f">
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link rel="stylesheet" href="styles/financial-styles.css">
  <link rel="stylesheet" href="styles/withdrawal-styles.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="financial-nav">
    <div class="nav-brand">
      <span class="brand-text">EVERNET FINANCE</span>
    </div>
    <div class="nav-links">
      <a href="financial-portal.html" class="nav-link">
        <i class="fas fa-chart-line"></i> Dashboard
      </a>
      <a href="withdrawal-management.html" class="nav-link">
        <i class="fas fa-toggle-on"></i> Manage Withdrawals
      </a>
      <a href="withdrawal-requests.html" class="nav-link active">
        <i class="fas fa-list-check"></i> Requests
      </a>
      <a href="#" class="nav-link" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="financial-container">
    <!-- Page Header -->
    <div class="page-header">
      <h1>Withdrawal Requests ðŸ“‹</h1>
      <p>Review and process creator withdrawal requests</p>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon pending">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-info">
          <span class="stat-value" id="pendingCount">0</span>
          <span class="stat-label">Pending Requests</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon approved">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
          <span class="stat-value" id="approvedCount">0</span>
          <span class="stat-label">Approved</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon paid">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-info">
          <span class="stat-value" id="paidCount">0</span>
          <span class="stat-label">Paid Out</span>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon total">
          <i class="fas fa-chart-bar"></i>
        </div>
        <div class="stat-info">
          <span class="stat-value" id="totalAmount">$0</span>
          <span class="stat-label">Total Processed</span>
        </div>
      </div>
    </div>

    <!-- Filter Controls -->
    <div class="filter-section">
      <div class="filter-group">
        <label>Status:</label>
        <select id="statusFilter" onchange="filterRequests()">
          <option value="all">All Status</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="paid">Paid</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Date Range:</label>
        <select id="dateFilter" onchange="filterRequests()">
          <option value="all">All Time</option>
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
        </select>
      </div>
      <div class="filter-actions">
        <button class="btn-export" onclick="exportRequests()">
          <i class="fas fa-download"></i> Export
        </button>
      </div>
    </div>

    <!-- Requests Table -->
    <div class="requests-table-section">
      <div class="section-header">
        <h2>Withdrawal Requests</h2>
        <div class="table-actions">
          <span class="results-count" id="resultsCount">0 requests</span>
        </div>
      </div>

      <div class="table-container">
        <table class="requests-table">
          <thead>
            <tr>
              <th>Creator</th>
              <th>Report Period</th>
              <th>Amount</th>
              <th>Requested</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="requestsTableBody">
            <!-- Requests loaded dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div class="empty-state" id="noRequestsEmpty" style="display: none;">
        <div class="empty-icon">
          <i class="fas fa-inbox"></i>
        </div>
        <h3>No Withdrawal Requests</h3>
        <p>There are no withdrawal requests matching your filters.</p>
      </div>
    </div>
  </div>

  <!-- Action Modal -->
  <div id="actionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Process Request</h3>
        <button class="modal-close" onclick="closeActionModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="request-details" id="modalRequestDetails">
          <!-- Request details loaded dynamically -->
        </div>
        
        <div class="action-section" id="actionSection">
          <!-- Action buttons loaded based on status -->
        </div>

        <div class="notes-section">
          <label for="adminNotes">Admin Notes (Optional):</label>
          <textarea id="adminNotes" placeholder="Add any notes about this request..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeActionModal()">Cancel</button>
        <div class="action-buttons" id="modalActionButtons">
          <!-- Action buttons loaded dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <script src="js/firebase-config.js"></script>
  <script src="js/auth-system.js"></script>
  <script src="js/withdrawal-system.js"></script>
  <script>
    class WithdrawalRequestsManager {
      constructor() {
        this.allRequests = [];
        this.filteredRequests = [];
        this.currentRequest = null;
        this.init();
      }

      init() {
        this.loadWithdrawalRequests();
        this.setupRealTimeListeners();
      }

      async loadWithdrawalRequests() {
        try {
          const snapshot = await db.collection('withdrawalRequests')
            .orderBy('requestedAt', 'desc')
            .get();

          this.allRequests = [];
          snapshot.forEach(doc => {
            this.allRequests.push({
              id: doc.id,
              ...doc.data()
            });
          });

          this.filterRequests();
          this.updateStats();

        } catch (error) {
          console.error('Error loading withdrawal requests:', error);
          this.showNotification('Error loading requests', 'error');
        }
      }

      filterRequests() {
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        const now = new Date();

        this.filteredRequests = this.allRequests.filter(request => {
          // Status filter
          if (statusFilter !== 'all' && request.status !== statusFilter) {
            return false;
          }

          // Date filter
          if (dateFilter !== 'all' && request.requestedAt) {
            const requestDate = request.requestedAt.toDate();
            switch (dateFilter) {
              case 'today':
                return requestDate.toDateString() === now.toDateString();
              case 'week':
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                return requestDate >= weekAgo;
              case 'month':
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                return requestDate >= monthAgo;
            }
          }

          return true;
        });

        this.displayRequests();
      }

      displayRequests() {
        const tbody = document.getElementById('requestsTableBody');
        const emptyState = document.getElementById('noRequestsEmpty');
        const resultsCount = document.getElementById('resultsCount');

        if (this.filteredRequests.length === 0) {
          tbody.innerHTML = '';
          emptyState.style.display = 'block';
          resultsCount.textContent = '0 requests';
          return;
        }

        emptyState.style.display = 'none';
        resultsCount.textContent = `${this.filteredRequests.length} requests`;

        tbody.innerHTML = this.filteredRequests.map(request => 
          this.createRequestRow(request)
        ).join('');
      }

      createRequestRow(request) {
        const statusConfig = {
          'pending': { class: 'pending', badge: 'Pending', icon: 'fa-clock' },
          'approved': { class: 'approved', badge: 'Approved', icon: 'fa-check' },
          'paid': { class: 'paid', badge: 'Paid', icon: 'fa-money-bill' },
          'rejected': { class: 'rejected', badge: 'Rejected', icon: 'fa-times' }
        };

        const config = statusConfig[request.status] || statusConfig.pending;
        const requestedDate = request.requestedAt?.toDate().toLocaleDateString() || 'Unknown';
        const period = this.formatMonth(request.reportMonth);

        return `
          <tr>
            <td>
              <div class="creator-cell">
                <div class="creator-name">${request.creatorName}</div>
                <div class="creator-email">${request.creatorEmail}</div>
              </div>
            </td>
            <td>${period}</td>
            <td class="amount-cell">$${request.amount?.toLocaleString()}</td>
            <td>${requestedDate}</td>
            <td>
              <span class="status-badge ${config.class}">
                <i class="fas ${config.icon}"></i> ${config.badge}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-view" onclick="viewRequest('${request.id}')">
                  <i class="fas fa-eye"></i> View
                </button>
                ${request.status === 'pending' ? `
                  <button class="btn-approve" onclick="openActionModal('${request.id}', 'approve')">
                    <i class="fas fa-check"></i> Approve
                  </button>
                  <button class="btn-reject" onclick="openActionModal('${request.id}', 'reject')">
                    <i class="fas fa-times"></i> Reject
                  </button>
                ` : ''}
                ${request.status === 'approved' ? `
                  <button class="btn-pay" onclick="openActionModal('${request.id}', 'pay')">
                    <i class="fas fa-money-bill"></i> Mark Paid
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }

      updateStats() {
        const pending = this.allRequests.filter(r => r.status === 'pending').length;
        const approved = this.allRequests.filter(r => r.status === 'approved').length;
        const paid = this.allRequests.filter(r => r.status === 'paid').length;
        
        const totalAmount = this.allRequests
          .filter(r => r.status === 'paid')
          .reduce((sum, r) => sum + (r.amount || 0), 0);

        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('approvedCount').textContent = approved;
        document.getElementById('paidCount').textContent = paid;
        document.getElementById('totalAmount').textContent = `$${totalAmount.toLocaleString()}`;
      }

      async openActionModal(requestId, action) {
        try {
          const requestDoc = await db.collection('withdrawalRequests').doc(requestId).get();
          
          if (!requestDoc.exists) {
            this.showNotification('Request not found', 'error');
            return;
          }

          this.currentRequest = { id: requestId, ...requestDoc.data() };
          this.updateActionModal(action);

          document.getElementById('actionModal').classList.add('show');

        } catch (error) {
          console.error('Error opening action modal:', error);
          this.showNotification('Error loading request details', 'error');
        }
      }

      updateActionModal(action) {
        const request = this.currentRequest;
        const period = this.formatMonth(request.reportMonth);
        const requestedDate = request.requestedAt?.toDate().toLocaleDateString() || 'Unknown';

        // Update modal title
        const actionTitles = {
          'approve': 'Approve Withdrawal Request',
          'reject': 'Reject Withdrawal Request', 
          'pay': 'Mark as Paid',
          'view': 'Request Details'
        };
        document.getElementById('modalTitle').textContent = actionTitles[action] || 'Request Details';

        // Update request details
        document.getElementById('modalRequestDetails').innerHTML = `
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Creator:</span>
              <span class="detail-value">${request.creatorName}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Email:</span>
              <span class="detail-value">${request.creatorEmail}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Report Period:</span>
              <span class="detail-value">${period}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Amount:</span>
              <span class="detail-value amount">$${request.amount?.toLocaleString()}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Requested:</span>
              <span class="detail-value">${requestedDate}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Current Status:</span>
              <span class="detail-value status-${request.status}">${request.status.toUpperCase()}</span>
            </div>
          </div>
        `;

        // Update action buttons
        let actionButtons = '';
        switch (action) {
          case 'approve':
            actionButtons = `
              <button class="btn-approve" onclick="processRequest('approve')">
                <i class="fas fa-check"></i> Approve Request
              </button>
            `;
            break;
          case 'reject':
            actionButtons = `
              <button class="btn-reject" onclick="processRequest('reject')">
                <i class="fas fa-times"></i> Reject Request
              </button>
            `;
            break;
          case 'pay':
            actionButtons = `
              <button class="btn-pay" onclick="processRequest('pay')">
                <i class="fas fa-money-bill"></i> Mark as Paid
              </button>
            `;
            break;
          default:
            actionButtons = `
              <button class="btn-secondary" onclick="closeActionModal()">Close</button>
            `;
        }

        document.getElementById('modalActionButtons').innerHTML = actionButtons;
      }

      async processRequest(action) {
        if (!this.currentRequest) return;

        try {
          const requestRef = db.collection('withdrawalRequests').doc(this.currentRequest.id);
          const adminNotes = document.getElementById('adminNotes').value;
          const updateData = {
            processedAt: new Date(),
            processedBy: authSystem.currentUser.uid,
            processorEmail: authSystem.currentUser.email,
            adminNotes: adminNotes || null
          };

          switch (action) {
            case 'approve':
              updateData.status = 'approved';
              updateData.approvedAt = new Date();
              break;
            case 'reject':
              updateData.status = 'rejected';
              updateData.rejectedAt = new Date();
              break;
            case 'pay':
              updateData.status = 'paid';
              updateData.paidAt = new Date();
              break;
          }

          await requestRef.update(updateData);

          // Log the action
          await db.collection('withdrawalLogs').add({
            action: `${action}_request`,
            requestId: this.currentRequest.id,
            creatorId: this.currentRequest.creatorId,
            amount: this.currentRequest.amount,
            performedBy: authSystem.currentUser.uid,
            performedAt: new Date(),
            notes: adminNotes
          });

          this.showNotification(`Request ${action}ed successfully!`, 'success');
          this.closeActionModal();

        } catch (error) {
          console.error('Error processing request:', error);
          this.showNotification(`Error ${action}ing request`, 'error');
        }
      }

      closeActionModal() {
        document.getElementById('actionModal').classList.remove('show');
        this.currentRequest = null;
        document.getElementById('adminNotes').value = '';
      }

      formatMonth(monthString) {
        if (!monthString) return 'Unknown Period';
        const [year, month] = monthString.split('-');
        const date = new Date(year, month - 1);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
      }

      setupRealTimeListeners() {
        // Real-time updates for withdrawal requests
        db.collection('withdrawalRequests')
          .orderBy('requestedAt', 'desc')
          .onSnapshot((snapshot) => {
            this.loadWithdrawalRequests();
          });
      }

      showNotification(message, type = 'error') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        
        setTimeout(() => {
          notification.style.display = 'none';
        }, 5000);
      }
    }

    // Global functions
    function filterRequests() {
      if (window.requestsManager) {
        window.requestsManager.filterRequests();
      }
    }

    function viewRequest(requestId) {
      if (window.requestsManager) {
        window.requestsManager.openActionModal(requestId, 'view');
      }
    }

    function openActionModal(requestId, action) {
      if (window.requestsManager) {
        window.requestsManager.openActionModal(requestId, action);
      }
    }

    function processRequest(action) {
      if (window.requestsManager) {
        window.requestsManager.processRequest(action);
      }
    }

    function closeActionModal() {
      if (window.requestsManager) {
        window.requestsManager.closeActionModal();
      }
    }

    function exportRequests() {
      // Export functionality would go here
      if (window.requestsManager) {
        window.requestsManager.showNotification('Export feature coming soon!', 'success');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (authSystem.hasRole('admin') || authSystem.hasRole('finance')) {
        window.requestsManager = new WithdrawalRequestsManager();
      } else {
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
